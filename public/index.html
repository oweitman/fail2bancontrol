<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fail2ban Web Interface</title>
    <style>
        /* Theme variables. Adjust these values to change colours globally. */
        :root {
            --bg-color: #f7f7f7;
            --text-color: #222;
            --card-bg: #ffffff;
            --border-color: #cccccc;
            --accent-color: #007bff;
            --button-text: #ffffff;
            --muted-bg: #f0f0f0;
        }
        /* Dark mode overrides */
        body.dark {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --border-color: #333333;
            --accent-color: #4e8ef7;
            --button-text: #ffffff;
            --muted-bg: #2a2a2a;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            margin-top: 0;
        }
        #controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 10px;
        }
        .theme-toggle {
            cursor: pointer;
            padding: 6px 12px;
            font-size: 14px;
            background-color: var(--accent-color);
            color: var(--button-text);
            border: none;
            border-radius: 4px;
        }
        .jaillink {
            color: var(--text-color);   
            text-decoration: none;
        }
        .jail {
            margin: 15px 0;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .jail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .jail-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        .btn {
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            color: var(--button-text);
            background-color: var(--accent-color);
        }
        .btn.small {
            font-size: 12px;
            padding: 3px 8px;
        }
        .ban-form {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .ban-form input {
            flex: 1;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--muted-bg);
            color: var(--text-color);
        }
        .ban-form button {
            padding: 6px 12px;
            color: var(--button-text);
            background-color: var(--accent-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .ip-list span {
            display: inline-flex;
            align-items: center;
            background: var(--muted-bg);
            margin: 2px 5px;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .ip-list button.unban-btn {
            margin-left: 8px;
            padding: 2px 6px;
            font-size: 12px;
            background-color: var(--accent-color);
            border: none;
            border-radius: 4px;
            color: var(--button-text);
            cursor: pointer;
        }
        .card-container {
            display: flex;
            gap: 1rem; /* Abstand zwischen den Karten */
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 0.5rem;
            flex: 1; /* beide Karten gleich breit */
            max-width: 260px; /* optional, um feste Breite zu behalten */
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .card h3 {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0.5rem;
        }

        .card .value {
            display: flex;
            justify-content: space-between;
            margin: 0.25rem 0.5rem;
        }

        .label {
            font-weight: 500;
        }

        .number {
            font-weight: 600;
            }
    </style>
</head>
<body>
    <div class="container">
        <div id="controls">
            <button id="theme-toggle" class="theme-toggle">Dark mode</button>
        </div>
        <h1 id="top">Fail2ban Web Control Panel</h1>
        <div id="status"></div>
        <div id="jails"></div>
    </div>

<script>
// Theme toggle: load saved theme and update button text. When clicked,
// toggle 'dark' class on body and persist choice in localStorage.
document.addEventListener('DOMContentLoaded', function () {
    const toggleBtn = document.getElementById('theme-toggle');
    function updateToggleText() {
        if (document.body.classList.contains('dark')) {
            toggleBtn.textContent = 'Light mode';
        } else {
            toggleBtn.textContent = 'Dark mode';
        }
    }
    // Load saved theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark');
    }
    updateToggleText();
    toggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        const isDark = document.body.classList.contains('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateToggleText();
    });
});
async function fetchStatus() {
    const res = await fetch('/api/status');
    const data = await res.json();
    const statusDiv = document.getElementById('status');
    statusDiv.innerHTML = data.jails + ' jail(s): ' + data.list.map(el=>`<a class="jaillink" href="#${el}">${el}</a>`).join(', ');
}

async function fetchJails() {
    const res = await fetch('/api/jails');
    const jails = await res.json();
    const jailsDiv = document.getElementById('jails');
    jailsDiv.innerHTML = '';
    for (const jail of jails) {
        const jailElem = document.createElement('div');
        jailElem.className = 'jail';
        jailElem.innerHTML = `
            <div id="${jail}" class="jail-header">
                <a class="jaillink" href="#top"><h2>${jail}</h2></a>
                <button class="btn small" onclick="loadJailStatus('${jail}')">Refresh</button>
            </div>
            <div id="jail-${jail}">Loading...</div>
        `;
        jailsDiv.appendChild(jailElem);
        loadJailStatus(jail);
    }
}

async function loadJailStatus(jail) {
    const div = document.getElementById('jail-' + jail);
    div.textContent = 'Loading...';
    try {
        const res = await fetch('/api/jail/' + encodeURIComponent(jail) + '/status');
        const data = await res.json();
        if (data.error) {
            div.textContent = 'Error: ' + data.error;
            return;
        }
        let html = '';
        html += '<div class="card-container">';
        html += '  <div class="card">';
        html += '    <h3>Failed</h3>';
        html += '    <div class="value">';
        html += '        <span class="label">Total:</span>';
        html += '        <span class="number">' + data.filter.totalFailed + '</span>';
        html += '    </div>';
        html += '    <div class="value">';
        html += '        <span class="label">Current:</span>';
        html += '        <span class="number">' + data.filter.currentlyFailed + '</span>';
        html += '    </div>';
        html += '  </div>';

        html += '  <div class="card">';
        html += '    <h3>Banned</h3>';
        html += '    <div class="value">';
        html += '        <span class="label">Total:</span>';
        html += '        <span class="number">' + data.actions.totalBanned + '</span>';
        html += '    </div>';
        html += '    <div class="value">';
        html += '        <span class="label">Current:</span>';
        html += '        <span class="number">' + data.actions.currentlyBanned + '</span>';
        html += '    </div>';
        html += '  </div>';
        html += '</div>';

        html += '<p><strong>File list:</strong> ' + data.filter.fileList.join(', ') + '</p>';

        // Render banned IP list. Use data attributes instead of inline
        // onclick handlers to avoid complex escaping issues. An event
        // listener is attached below after the HTML is injected.
        html += '<p><strong>Banned IPs:</strong> <span class="ip-list">' +
            data.actions.bannedIPList.map(ip =>
                '<span>' + ip + ' <button class="unban-btn" data-jail="' + jail + '" data-ip="' + ip + '">Unban</button></span>'
            ).join('') + '</span></p>';
        // Form to ban a new IP
        html += `
            <form class="ban-form" onsubmit="banIP(event, '${jail}')">
                <input type="text" name="ip" placeholder="IP to ban">
                <button type="submit">Ban IP</button>
            </form>
        `;
        // Inject the generated HTML into the jail container
        div.innerHTML = html;
        // Attach click handlers to all unban buttons inside this jail
        div.querySelectorAll('button.unban-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const j = btn.dataset.jail;
                const ipVal = btn.dataset.ip;
                unbanIP(j, ipVal);
            });
        });
    } catch (e) {
        div.textContent = 'Error loading jail status: ' + e;
    }
}

async function banIP(event, jail) {
    event.preventDefault();
    const ip = event.target.ip.value;
    if (!ip) return;
    await fetch('/api/jail/' + encodeURIComponent(jail) + '/ban', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ip})
    });
    event.target.ip.value = '';
    loadJailStatus(jail);
}

async function unbanIP(jail, ip) {
    await fetch('/api/jail/' + encodeURIComponent(jail) + '/unban', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ip})
    });
    loadJailStatus(jail);
}

fetchStatus();
fetchJails();
</script>
</body>
</html>